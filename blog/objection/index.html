<!DOCTYPE html><html><head><meta charset="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="preload" href="/on-learning-new-things/component---src-layouts-index-js-1d457095af01b5bbd191.js" as="script"/><link rel="preload" href="/on-learning-new-things/component---src-templates-blog-template-js-b0c2fa9e4dd50e0858d2.js" as="script"/><link rel="preload" href="/on-learning-new-things/path---blog-objection-66b0c08a076093af32f5.js" as="script"/><link rel="preload" href="/on-learning-new-things/app-552368e0c7fe45952487.js" as="script"/><link rel="preload" href="/on-learning-new-things/commons-37e7ec241aad23eaba66.js" as="script"/><title data-react-helmet="true">On Learning New Things</title><meta data-react-helmet="true" name="description" content="Sample"/><meta data-react-helmet="true" name="keywords" content="sample, something"/><style id="gatsby-inlined-css">@import url(https://fonts.googleapis.com/css?family=Montserrat:400,500,700|Playfair+Display:400,500);body{font-family:Montserrat,sans-serif;color:#4a4a4a}a{text-decoration:none}.rainbow-text{text-align:center}h2{font-family:Playfair Display,serif;font-size:20px;font-weight:700}a{color:#3949ab}.article-link>a{color:#000}.contact>a{display:block}.tags{display:-ms-grid;display:grid;-ms-grid-columns:(1fr)[2];grid-template-columns:repeat(2,1fr);margin-bottom:20px}img{display:block;margin-left:auto;margin-right:auto}h4{text-align:center}.container{margin-left:5%;margin-right:5%;display:-ms-grid;display:grid;-ms-grid-columns:3fr 1fr;grid-template-columns:3fr 1fr;grid-gap:30px}.continue-reading{font-weight:600;color:#4a4a4a}.rainbow-text span{font-weight:700;font-size:50px}.rainbow-text span:nth-child(10n+1){color:#ef5350}.rainbow-text span:nth-child(10n+2){color:#ab47bc}.rainbow-text span:nth-child(10n+3){color:#651fff}.rainbow-text span:nth-child(10n+4){color:#3949ab}.rainbow-text span:nth-child(10n+5){color:#2196f3}.rainbow-text span:nth-child(10n+6){color:#00bcd4}.rainbow-text span:nth-child(10n+7){color:#4caf50}.rainbow-text span:nth-child(10n+8){color:#ffc107}.rainbow-text span:nth-child(10n+9){color:#ff80ab}.rainbow-text span:nth-child(10n+10){color:#ff8f00}.red{background-color:#ef5350}.pink{background-color:#ff80ab}.purple{background-color:#651fff}.blog-post-container{margin-left:5%;margin-right:5%}.vertical-line{border-left:1px solid #4a4a4a;height:100%;padding-left:20px}.shapes>div{text-align:center;height:50px;width:50px;display:inline-block;margin-left:15px}.circle{border-radius:50%}.blue{background-color:#00bcd4}.green{background-color:#4caf50}.yellow{background-color:#ffc107}.triangle{-webkit-clip-path:polygon(50% 0,0 100%,100% 100%);clip-path:polygon(50% 0,0 100%,100% 100%)}@media (max-width:850px){.container{display:-ms-flexbox;display:flex;-ms-flex-direction:column;flex-direction:column}.about,.vertical-line{display:none}}@media (max-width:600px){.rainbow-text span{font-size:30px}}img{max-width:100%}code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#a67f59;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style></head><body><div id="___gatsby"><div data-reactroot="" data-reactid="1" data-react-checksum="-144102245"><!-- react-empty: 2 --><div data-reactid="3"><a href="/on-learning-new-things/" data-reactid="4"><h1 class="rainbow-text" data-reactid="5"><div data-reactid="6"><span data-reactid="7">O</span><span data-reactid="8">N</span><span data-reactid="9">  </span><span data-reactid="10">L</span><span data-reactid="11">E</span><span data-reactid="12">A</span><span data-reactid="13">R</span><span data-reactid="14">N</span><span data-reactid="15">I</span><span data-reactid="16">N</span><span data-reactid="17">G</span><span data-reactid="18">  </span><span data-reactid="19">N</span><span data-reactid="20">E</span><span data-reactid="21">W</span></div><div data-reactid="22"><span data-reactid="23">T</span><span data-reactid="24">H</span><span data-reactid="25">I</span><span data-reactid="26">N</span><span data-reactid="27">G</span><span data-reactid="28">S</span></div></h1></a></div><div class="blog-post-container" data-reactid="29"><div class="blog-post" data-reactid="30"><h1 data-reactid="31">Objection + Knex = Painless PostgreSQL in your Node App</h1><h2 data-reactid="32">February 20, 2017</h2><div class="blog-post-content" data-reactid="33"><p>It's no secret that I'm a total PostgreSQL fangirl -- I rarely see a use case for using a different database, especially with the support for array and JSON fields. I also love Node and Express for simple APIs (without auth). In the past, SQL support within Node and Express hasn't been perfect. I've been hearing great things about <a href="https://vincit.github.io/objection.js">Objection</a>, so I decided to try it out!</p>
<p>Objection, which is built on top of <a href="http://knexjs.org/">Knex</a>, uses the new ES7 class features to build a nice ORM query language for Node. ORMs allow you to use whatever programming language you are using for your app to query a database rather than querying in the natie language of the database (here we will use JavaScript to interact with our database instead of SQL). Since Objection is still really new, I will be walking through all of my code step by step.</p>
<h2>The Learning Process</h2>
<p>For this project, I relied pretty much exclusively on the documentation. The Knex documentation was great, and there were <a href="https://github.com/Vincit/objection.js/tree/master/examples/express-es6">examples</a> on the Objection GitHub that were very helpful as well. Since I make so many Express apps, given that I teach Express pretty extensively to my students, I felt pretty comfortable continuing with the project after skimming these resources.</p>
<h2>The Final Project</h2>
<p>I've been having trouble coming up with app ideas for this blog! So, I built an app idea app! The models were relatively simple: <code>ideas</code> and <code>comments</code>, but they still demonstrate one of the biggest use cases for Objection: relations between data. The <code>ideas</code> will be the "parents" with "child" comments attached to them. Essentially, users will be able to comment on various app ideas.</p>
<h4>Knex Initialization</h4>
<p>First, I initialized Knex, which will facilitate our database connection using <code>pg</code>, our migrations, and our seeds. After setting up my typical Express API boilerplate in my <a href="https://github.com/aspittel/app-ideas/blob/master/index.js">index file</a> and installing the requirements in my <a href="https://github.com/aspittel/app-ideas/blob/master/package.json">package.json</a>, I ran <code>knex init</code> in the root of my project. This created a <code>knexfile.js</code> that contains a boilerplate with example connections to databases. I decided to remove the <code>production</code>, <code>development</code>, and <code>staging</code> options in favor of just specifying a database connection string in my <code>.env</code> file. The <code>knexfile</code> ended up looking like:</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js"><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> pg <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'pg'</span><span class="token punctuation">)</span>
pg<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>ssl <span class="token operator">=</span> <span class="token boolean">true</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  client<span class="token punctuation">:</span> <span class="token string">'pg'</span><span class="token punctuation">,</span>
  connection<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>DATABASE_URL
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>The <code>ssl</code> configuration is only necessary if you are using a database on Heroku or another provider that requires an SSL connection. <code>dotenv</code> allows us to retrieve environmental variables from a <code>.env</code> file! That variable is a standard PostgreSQL connection string:</p>
<div class="gatsby-highlight">
      <pre class="language-bash"><code class="language-bash">DATABASE_URL<span class="token operator">=</span>postgres://username:password@host:port/db_name
</code></pre>
      </div>
<p>I created the database on my computer using <code>psql</code>, I created the production database using a <a href="https://elements.heroku.com/addons/heroku-postgresql">Heroku add-on</a>.</p>
<h4>Migrations</h4>
<p>Migrations are changes to a database's schema specified within your ORM, so we will be defining the tables and columns of our database straight in JavaScript rather than using SQL.</p>
<p>From there, I generated my migrations:</p>
<div class="gatsby-highlight">
      <pre class="language-bash"><code class="language-bash">$ knex migrate:make create_ideas
$ knex migrate:make create_comments
</code></pre>
      </div>
<p>Each migrate command created its own separate file in the <code>migrations</code> folder. Knex also puts a timestamp on each so that the migration name is unique and is run in order, for example: migrations/20180218215453<em>create</em>ideas.js. I created two separate migrations to keep things organized, and because I created the comments after the ideas. These could be combined, though.</p>
<p>The migration is generated with:</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js">exports<span class="token punctuation">.</span><span class="token function-variable function">up</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>knex<span class="token punctuation">,</span> Promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">down</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>knex<span class="token punctuation">,</span> Promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>The migration itself goes within the body of the <code>exports.up</code> function and then whatever the opposite of that migration does goes within <code>exports.down</code>. The <code>exports.down</code> allows us to undo migrations that we no longer want. For the <code>create_ideas</code> migration, I added the following:</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js">exports<span class="token punctuation">.</span><span class="token function-variable function">up</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>knex<span class="token punctuation">,</span> Promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    knex<span class="token punctuation">.</span>schema<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">'ideas'</span><span class="token punctuation">,</span> table <span class="token operator">=></span> <span class="token punctuation">{</span>
      table<span class="token punctuation">.</span><span class="token function">increments</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">primary</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      table<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">'idea'</span><span class="token punctuation">)</span>
      table<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">'creator'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">down</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>knex<span class="token punctuation">,</span> Promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    knex<span class="token punctuation">.</span>schema<span class="token punctuation">.</span><span class="token function">dropTable</span><span class="token punctuation">(</span><span class="token string">'ideas'</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>Knex migration functions should "always return a promise" according to its documentation. We can use <code>Promise.all()</code> in order to return an array of promises to resolve. Even though each function only has one action in this case, I could have added more actions separated by <code>,</code>'s. The <code>exports.up</code> contains the table creation logic for the <code>ideas</code> table, including a primary key that is auto-incremented <code>table.increments('id').primary()</code>. It also has two other string columns called <code>idea</code> and <code>creator</code>. To undo the migration, we would drop the <code>ideas</code> table, as specified in the <code>exports.down</code> function.</p>
<p>The second migration to create the <code>comments</code> file is similar:</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js">exports<span class="token punctuation">.</span><span class="token function-variable function">up</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>knex<span class="token punctuation">,</span> Promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    knex<span class="token punctuation">.</span>schema<span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">'comments'</span><span class="token punctuation">,</span> table <span class="token operator">=></span> <span class="token punctuation">{</span>
      table<span class="token punctuation">.</span><span class="token function">increments</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">primary</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      table<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">'comment'</span><span class="token punctuation">)</span>
      table<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">'creator'</span><span class="token punctuation">)</span>
      table<span class="token punctuation">.</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token string">'ideas_id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">references</span><span class="token punctuation">(</span><span class="token string">'ideas.id'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">down</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>knex<span class="token punctuation">,</span> Promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    knex<span class="token punctuation">.</span>schema<span class="token punctuation">.</span><span class="token function">dropTable</span><span class="token punctuation">(</span><span class="token string">'comments'</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>This migration looks very similar to the <code>ideas</code> one, the only difference is the foreign key: <code>table.integer('ideas_id').references('ideas.id')</code>. There are many ways to do this specified in the documentation; however, the Objection documentation does it this way so I did as well. Knex enforced the column name <code>ideas_id</code> rather than <code>idea_id</code> which was unsemantic. I am sure there is a way around that naming mandate; however, I didn't put much effort into looking it up!</p>
<p>Finally, I ran the migrations using the command:</p>
<div class="gatsby-highlight">
      <pre class="language-bash"><code class="language-bash">$ knex migrate:latest
</code></pre>
      </div>
<p>Even though the command implies it runs only the latest migration, it instead runs all migrations that haven't been run yet.</p>
<h4>Database Seeding</h4>
<p>Knex also has some built-in functionality to help us seed, or add initial test data, to our database.</p>
<div class="gatsby-highlight">
      <pre class="language-bash"><code class="language-bash">$ knex seed:make ideas
</code></pre>
      </div>
<p>The above command created a <code>seeds</code> directory with an <code>ideas.js</code> file within it. That file also had the following code in it:</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js">exports<span class="token punctuation">.</span><span class="token function-variable function">seed</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>knex<span class="token punctuation">,</span> Promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>I added the following:</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js">exports<span class="token punctuation">.</span><span class="token function-variable function">seed</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>knex<span class="token punctuation">,</span> Promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">knex</span><span class="token punctuation">(</span><span class="token string">'ideas'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">knex</span><span class="token punctuation">(</span><span class="token string">'ideas'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>creator<span class="token punctuation">:</span> <span class="token string">'Ali'</span><span class="token punctuation">,</span> idea<span class="token punctuation">:</span> <span class="token string">'A To Do List app!'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>creator<span class="token punctuation">:</span> <span class="token string">'Ali'</span><span class="token punctuation">,</span> idea<span class="token punctuation">:</span> <span class="token string">'A Blog!'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>creator<span class="token punctuation">:</span> <span class="token string">'Ali'</span><span class="token punctuation">,</span> idea<span class="token punctuation">:</span> <span class="token string">'A calculator'</span><span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>This cleared the <code>ideas</code> table, so there wasn't any data in the table, and then it inserted three records into the database. It used the JSON keys and values to create those rows. I only seeded the <code>ideas</code> table, but you could definitely seed the <code>comments</code> table as well!</p>
<p>I then ran the following command to update the database:</p>
<div class="gatsby-highlight">
      <pre class="language-bash"><code class="language-bash">$ knex seed:run
</code></pre>
      </div>
<h4>Models</h4>
<p>Up until this point, we have been using Knex to interact with our database. Now, we are going to create some models using Objection in order to deal with the relationships between our database tables and to make our querying more explicit! I created a <code>models</code> folder with a <code>schema.js</code> file within it. You could structure this pretty much anyway -- one good way would be to have each model in a different file. I kept everything together, though, for demonstration's sake!</p>
<p>First, let's take care of some administrative things at the top:</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> Knex <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'knex'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../knexfile'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Model <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'objection'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> knexConnection <span class="token operator">=</span> <span class="token function">Knex</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span>

Model<span class="token punctuation">.</span><span class="token function">knex</span><span class="token punctuation">(</span>knexConnection<span class="token punctuation">)</span>
</code></pre>
      </div>
<p>These lines of code connect us to the database using our <code>knexfile</code> from earlier. We are also attaching Objection to our database connection. </p>
<p>Now, let's create our model for our <code>Comment</code> data. The models will allow us to interact cleanly with the data we are retrieving from our database.</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Comment</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">tableName</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'comments'</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">relationMappings</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      idea<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        relation<span class="token punctuation">:</span> Model<span class="token punctuation">.</span>BelongsToOneRelation<span class="token punctuation">,</span>
        modelClass<span class="token punctuation">:</span> Idea<span class="token punctuation">,</span>
        join<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token keyword">from</span><span class="token punctuation">:</span> <span class="token string">'comments.ideas_id'</span><span class="token punctuation">,</span>
          to<span class="token punctuation">:</span> <span class="token string">'ideas.id'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      </div>
<p>Let's break this down. The static getter method <code>tableName</code> returns the name <code>comments</code>: the name of the database table we want our <code>Comment</code> class to model! We also have a second static getter method that defines the <code>Comment</code> model's relationships to other models. In this case, the key of the outside object <code>idea</code> is how we will refer to the parent class. The <code>relation</code> key within the child object has the value <code>Model.BelongsToOneRelation</code> which says that each comment is going to have one parent idea. The <code>modelClass</code> says that the <code>idea</code> is coming from the <code>Idea</code> model and then the <code>join</code> specifies the database table and column names to perform a SQL join on, in this case, the <code>ideas_id</code> column in the <code>comments</code> table to the <code>id</code> column in the <code>ideas</code> table.  <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes/static">static</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/get">get</a> were added in ES6!</p>
<p>The Idea class looks almost identical, though the relationships are inverted!</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Idea</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">tableName</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'ideas'</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">relationMappings</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      comments<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        relation<span class="token punctuation">:</span> Model<span class="token punctuation">.</span>HasManyRelation<span class="token punctuation">,</span>
        modelClass<span class="token punctuation">:</span> Comment<span class="token punctuation">,</span>
        join<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          <span class="token keyword">from</span><span class="token punctuation">:</span> <span class="token string">'ideas.id'</span><span class="token punctuation">,</span>
          to<span class="token punctuation">:</span> <span class="token string">'comments.ideas_id'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> Idea<span class="token punctuation">,</span> Comment <span class="token punctuation">}</span>
</code></pre>
      </div>
<p>In this case, our relationship is <code>Model.HasManyRelation</code> since one idea can have multiple comments! I also exported the models so they could be used within our other files.</p>
<h4>Querying</h4>
<p>The final file I worked with was <code>controllers/ideas.js</code>. I usually separate all my "controller" functions -- the routing functions that decide what each route renders -- into a file or files if there are lots of them! This week, I built an API that I will build a front-end for in the future.</p>
<p>First, some imports:</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> Idea<span class="token punctuation">,</span> Comment <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../models/schema'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
      </div>
<p>Let's walk through the first method, a get request that returns all of the <code>ideas</code>:</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js">router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ideas <span class="token operator">=</span> <span class="token keyword">await</span> Idea<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>ideas<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
      </div>
<p>In the above example, we are making the arrow function callback that handles the request and response asynchronous using <code>async</code>, then we can "pause" the body of the function until the promise from our <code>Idea.query()</code> resolves. That query will return a JavaScript object with all of the items in our <code>ideas</code> table using our <code>res.json(ideas)</code> method. If we navigate to <code>localhost:3000/ideas</code> locally or <code>https://application-ideas.herokuapp.com/ideas</code> in production we see:</p>
<div class="gatsby-highlight">
      <pre class="language-json"><code class="language-json"><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">"idea"</span><span class="token operator">:</span> <span class="token string">"A To Do List app!"</span><span class="token punctuation">,</span>
        <span class="token property">"creator"</span><span class="token operator">:</span> <span class="token string">"Ali"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token property">"idea"</span><span class="token operator">:</span> <span class="token string">"A Blog!"</span><span class="token punctuation">,</span>
        <span class="token property">"creator"</span><span class="token operator">:</span> <span class="token string">"Ali"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token property">"idea"</span><span class="token operator">:</span> <span class="token string">"A calculator"</span><span class="token punctuation">,</span>
        <span class="token property">"creator"</span><span class="token operator">:</span> <span class="token string">"Ali"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre>
      </div>
<p>Note: The Objection documentation uses <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function">async and await</a> to handle <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">promises</a> in JavaScript; however, we could rewrite the above function to look like the following and that would work equally as well!</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js">router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  Idea<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>ideas <span class="token operator">=></span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>ideas<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
      </div>
<p>Instead of going through the other routes in paragraph form, I am going to put the annotated code below:</p>
<div class="gatsby-highlight">
      <pre class="language-js"><code class="language-js">router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// gets one idea, found by id.</span>
  <span class="token comment">//Also fetches the related comments using the .eager method</span>
  <span class="token keyword">const</span> idea <span class="token operator">=</span> <span class="token keyword">await</span> Idea<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eager</span><span class="token punctuation">(</span><span class="token string">'comments'</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>idea<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// creates a new idea from the request body</span>
  <span class="token comment">// only allows the idea and creator fields for safety</span>
  <span class="token keyword">const</span> newIdea <span class="token operator">=</span> req<span class="token punctuation">.</span>body

  <span class="token keyword">const</span> idea <span class="token operator">=</span> <span class="token keyword">await</span> Idea<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                         <span class="token punctuation">.</span><span class="token function">allowInsert</span><span class="token punctuation">(</span><span class="token string">'[idea, creator]'</span><span class="token punctuation">)</span>
                         <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>newIdea<span class="token punctuation">)</span>

  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>idea<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/:id/comments'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// creates a new comment that is a child of an idea, again sanitizes fields.</span>
  <span class="token keyword">const</span> idea <span class="token operator">=</span> <span class="token keyword">await</span> Idea<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span>

  <span class="token keyword">await</span> idea<span class="token punctuation">.</span><span class="token function">$relatedQuery</span><span class="token punctuation">(</span><span class="token string">'comments'</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">allowInsert</span><span class="token punctuation">(</span><span class="token string">'[comment, creator]'</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span>

  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>idea<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// deletes an idea</span>
  <span class="token keyword">await</span> Idea<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span>

  res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/ideas'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token string">'/:id/comments/:commentId'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// deletes a comment</span>
  <span class="token keyword">await</span> Comment<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>commentId<span class="token punctuation">)</span>

  res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`/ideas/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre>
      </div>
<p>There's a bunch more you can do with Objection, like <a href="http://vincit.github.io/objection.js/#raw-queries">raw queries</a>, interaction with <a href="http://vincit.github.io/objection.js/#json-queries">JSON fields</a>, and <a href="http://vincit.github.io/objection.js/#validation">validations</a>.</p>
<h2>Next Steps</h2>
<p>I had a really fun time working with Objection and Knex! It is honestly very similar to working with Mongoose and MongoDB from a configuration standpoint, but it makes hierarchical and related data so much easier to work with! I would definitely keep using these libraries in the future with Express apps! Definitely a must-try if you use Node frequently!</p>
<p>Coming next week: a front-end for this API! Please leave a comment or <a href="https://twitter.com/aspittel">tweet me</a> with suggestions for a front-end tool to use for it!</p>
<p><a href="https://github.com/aspittel/app-ideas">Full Code</a>
<a href="https://application-ideas.herokuapp.com/ideas">Deployed App</a>
<a href="http://vincit.github.io/objection.js">Objection Documentation</a>
<a href="http://knexjs.org/">Knex Documentation</a></p>
<p><strong>Part of my <a href="https://medium.com/on-learning-new-things/learning-new-things-f4db7f16724">On Learning New Things</a> Series</strong></p></div></div></div></div></div><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-552368e0c7fe45952487.js","122212659448958":"component---src-templates-blog-template-js-b0c2fa9e4dd50e0858d2.js","50739212244294":"component---src-templates-tags-js-838eddff46fddb5dfa01.js","162898551421021":"component---src-pages-404-js-4503918ea3a16cfcdb75.js","35783957827783":"component---src-pages-index-js-2d8370aac263077f077e.js","60335399758886":"path----557518bd178906f8d58a.js","59922266386898":"path---blog-blogging-5059ee307419edffd2f6.js","14397910593448":"path---blog-sketch-802715cfc03f81791f37.js","277440900667115":"path---blog-electron-f88dc85572ca33379ebb.js","278183092840852":"path---blog-hyperapp-14d60aaddc22d346b795.js","266857328088181":"path---blog-angular-38cbd0545a32954e8cde.js","280534838832661":"path---blog-go-53f73efcab5b27d81e47.js","214721871774937":"path---blog-facial-recognition-8581ceac309e622203c8.js","18826368022058":"path---blog-socket-io-cb85c81632d922ad7c63.js","173203448334963":"path---blog-portfolio-3bfaba8cba913fcec69c.js","150126350409309":"path---blog-css-art-6d82e128a9bd672a04a2.js","206703267315727":"path---blog-elm-53b59387b50441f6fff5.js","16961111620731":"path---blog-objection-66b0c08a076093af32f5.js","36163852562177":"path---blog-web-components-aece5ee72bccf098ad71.js","92900522393385":"path---tags-blogging-c01e51f7f002b1102814.js","16116559206549":"path---tags-sketch-8b770c44fd86fecfd081.js","182244304492131":"path---tags-frontend-803a0668c044bd854b23.js","65951750749414":"path---tags-design-b4eb27f9ed7ef3c90e95.js","85240199557489":"path---tags-electron-0868a493b392b655acef.js","212641908305216":"path---tags-java-script-a6ded6dafd1f3a8ed139.js","142392486306457":"path---tags-desktop-4965dd1bcebbc512ec66.js","62117242295850":"path---tags-angular-8010624bb6a5bc3ea8b8.js","29981209658063":"path---tags-go-a051d916a10d5a3dc8e0.js","155610972471906":"path---tags-api-e617b678a928130fdf32.js","126371996568223":"path---tags-backend-1aac7f6964bff2fb59f2.js","191746713266591":"path---tags-postgre-sql-f02bd3b818e4d68665ec.js","127884858547399":"path---tags-data-science-20c41f09082d500e13c3.js","180636046567252":"path---tags-augmented-reality-2833ea985596d6774f22.js","264698647898761":"path---tags-websockets-f1e2c0c4569b78df3fad.js","209063065961547":"path---tags-css-99c98b3afca86c3b1386.js","15590976663347":"path---tags-art-492bc9efde252c8dc3a1.js","237869553599078":"path---tags-elm-e841f7189f93b599c06c.js","71230123872026":"path---tags-node-c6bd19143853242b1753.js","156812407687310":"path---tags-web-components-0bace97cf0d5ee015c8c.js","254022195166212":"path---404-a0e39f21c11f6a62c5ab.js","142629428675168":"path---index-a4c9b349d82e46f3e03f.js","178698757827068":"path---404-html-a0e39f21c11f6a62c5ab.js","114276838955818":"component---src-layouts-index-js-1d457095af01b5bbd191.js"}/*]]>*/</script><script>
  function gaOptout(){document.cookie=disableStr+'=true; expires=Thu, 31 Dec 2099 23:59:59 UTC;path=/',window[disableStr]=!0}var gaProperty='UA-116285482-1',disableStr='ga-disable-'+gaProperty;document.cookie.indexOf(disableStr+'=true')>-1&&(window[disableStr]=!0);
  if(!(navigator.doNotTrack == "1" || window.doNotTrack == "1")) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  }
  if (typeof ga === "function") {
    ga('create', 'UA-116285482-1', 'auto');
      ga('set', 'anonymizeIp', 1);}
      </script><script>/*<![CDATA[*/!function(e,t,r){function n(){for(;d[0]&&"loaded"==d[0][f];)c=d.shift(),c[o]=!i.parentNode.insertBefore(c,i)}for(var s,a,c,d=[],i=e.scripts[0],o="onreadystatechange",f="readyState";s=r.shift();)a=e.createElement(t),"async"in i?(a.async=!1,e.head.appendChild(a)):i[f]?(d.push(a),a[o]=n):e.write("<"+t+' src="'+s+'" defer></'+t+">"),a.src=s}(document,"script",["/on-learning-new-things/commons-37e7ec241aad23eaba66.js","/on-learning-new-things/app-552368e0c7fe45952487.js","/on-learning-new-things/path---blog-objection-66b0c08a076093af32f5.js","/on-learning-new-things/component---src-templates-blog-template-js-b0c2fa9e4dd50e0858d2.js","/on-learning-new-things/component---src-layouts-index-js-1d457095af01b5bbd191.js"])/*]]>*/</script></body></html>